{% extends "header.html" %}
{% block content %}

<!-- Load the Javascript -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script type="text/javascript">
    $('#loading_extra').hide();
    // Load the Visualization API and the corechart package.
      google.charts.load('current', {'packages':['corechart', 'controls']});

    // Callback that creates and populates a data table,
    // instantiates the chart, passes in the data and draws it.
    function drawChart(filtertype,city) {
      var filter = document.getElementById("origin_input");
      if (typeof city === "undefined") {
      city = filter.value.toUpperCase();
      mixpanel.track("Popularity selection", {"Origin": filter.value,});
      };
      // prepare the URL to call
      var url_to_call = './popularity_data/'+filtertype+'/'+city;

      // loading image until the chart is done
      $('#loading_extra').show();

      // call API and pass the data to the drawchart function
      $.ajax({
          type: 'GET',
          url: url_to_call,
          dataType: "json",
          crossDomain: true,
          success: function (api_results) {
              data_to_display=api_results;
              update_time = new Date(api_results.update);
              document.getElementById("update_time").innerHTML = update_time.toDateString() ;

              // Create the data table.
              var data_formatted = new google.visualization.DataTable();
              data_formatted.addColumn('string', 'Origin');
              data_formatted.addColumn('string', 'Destination');
              data_formatted.addColumn('string', 'O&D');
              data_formatted.addColumn('number', 'Popularity');
              for (i = 0; i < data_to_display.length ; i++) {
                    data_formatted.addRows([data_to_display.data[i]]);
              };
              // Create a chart, passing some options
              myChart = new google.visualization.ChartWrapper({
                    'chartType': 'BarChart',
                    'containerId': 'chart_div',
                    'dataTable': data_formatted,
                    // The  chart will use the columns '2' and '3' - note:index start at 0
                    'view': {'columns': [2,3]},
                    'options': {
                      'width': 700,
                      'height':600,
                      'chartArea': {height: '90%'},
                      'colors': ['#00b2d6'],
                      'backgroundColor': { fill:'#FFFFFF' },
                      'vAxis': {title: 'O&D',
                                textStyle: {color: '#272133', fontName: "Helvetica",fontSize: 16},
                                titleTextStyle: {color: '#272133', fontName: "Helvetica",fontSize: 18}},
                      'hAxis': {title: 'Popularity Index',
                                minValue: 0,
                                baselineColor: '#DFDCE3',
                                textStyle: {color: '#272133', fontName: "Helvetica",fontSize: 16},
                                titleTextStyle: {color: '#272133', fontName: "Helvetica",fontSize: 18},
                                gridlines: {count: 0}},
                      'legend': {position: 'none'},
                  //  animation doesn't work with dataview - bug
                    }
                });

                // Draw the chart
                myChart.draw();

          // closing the success clause of the AJAX call
          },
          complete: function(){
            $('#loading_image').hide();
            $('#loading_extra').hide();
            $('#dashboard_wrapper').show();
          },
          error: function (request, status, error) {
            console.log(error);
          }
        });
    };

    $(document).ready(function () {
        // loading image until the chart is done
        $('#dashboard_wrapper').hide();
        $('#loading_image').show();
        drawChart('o','LON');

    });

    </script>

  <!-- HTML -->
          <div class="bg-white container_12 ta-c">
            <div class="title"> Popular O&D </div>
            <!--Div that holds the animated gif until the chart loads-->
            <div id="loading_image" class="grid_12 pb-30">
              <img src="{{ url_for('static', filename='loading.gif') }}"></img>
            </div>
          </div>

          <div class="bg-white">
           <div class="container_12 ta-c fs-18">
             <div id="dashboard_wrapper">
                 <!--Divs that will hold each control and chart-->
                 <div id="chart_div" class="zlow"></div>
                 <div class='container_12 filter-bar'>
                   <div class='grid_4'> &nbsp </div>
                   <input id="origin_input" class='grid_4' type="text" value="Filter origin city (e.g. TYO)" onfocus='if (this.value=="Filter origin city (e.g. TYO)") {this.value="";}' onchange="filter_origin = this.value;">
                   <input type="button" class="grid_2 button-style" value="check" onClick="drawChart('o',undefined)">
                   <img id="loading_extra" src="{{ url_for('static', filename='loading_extra.gif') }}"></img>
                 </div>
              <div class="container_12 ta-c">
                <span class=" text-icon "> Last updated on: </span>
                <span id="update_time" class=" text-icon"> - </span>
              </div>
            </div>
          </div>
          </div>


{% endblock %}
