{% extends "header.html" %}
{% block content %}


    <script>


      function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 10, lng: 0},
          zoom: 2,
          gestureHandling: 'cooperative',
          scrollwheel: false,
          styles: [
            {elementType: 'geometry', stylers: [{color: '#DFDCE3'}]},
            {featureType: 'water', elementType: 'geometry',stylers: [{color: '#272133'}]},
          ]
        });
      };

      function draw_map() {
        $('#loading_extra').show();

        var filter = document.getElementById("ODinput");
        var od = filter.value;
        var origin = od.substring(0,3);
        var destination = od.substring(4,7);
        var url_to_call = './itineraries_data/'+origin+'/'+destination

        $.ajax({
            type: 'GET',
            url: url_to_call,
            dataType: "json",
            crossDomain: true,
            success: function (api_results){
              result_table = api_results.data;
            },
            complete: function(){
            $('#loading_extra').hide();
            if (origin > 'AAA' && destination > 'AAA'){
            var itintable = result_table.filter(function (table) {
                  return table[0] == origin &&
                         table[4] == destination ;
                });
            var maxpopularity = Math.max(itintable[0][14], itintable[1][14],itintable[2][14],itintable[3][14],itintable[4][14])
            //drawing the lines
            for (i = 0; i < Math.min(itintable.length,5); i++){
            var flightPlanCoordinates = [];
              // filling up the null values with the previous stop/origin (itineraries with less than 2 stops)
              if (itintable[i][9] == null) {
                  itintable[i][9] =  itintable[i][2];
                  itintable[i][10] = itintable[i][3];
                  itintable[i][12] =  itintable[i][2];
                  itintable[i][13] = itintable[i][3] }
                else {
                  if (itintable[i][12] == null) {
                  itintable[i][12] =  itintable[i][6];
                  itintable[i][13] = itintable[i][7]};
                };
              flightPlanCoordinates = [
                {lat:itintable[i][2],lng:itintable[i][3]},
                {lat:itintable[i][9],lng:itintable[i][10]},
                {lat:itintable[i][12],lng:itintable[i][13]},
                {lat:itintable[i][6],lng:itintable[i][7]}
              ];
            var flightPath = new google.maps.Polyline({
              path: flightPlanCoordinates,
              geodesic: true,
              strokeColor: '#5be2ed',
              strokeOpacity: 1.0,
              strokeWeight: 5*itintable[i][14]/maxpopularity
            });
            flightPath.setMap(map);

            // adding markers to show airports
            var marker_from = new google.maps.Marker({
              position: {lat:itintable[i][2],lng:itintable[i][3]},
              label: itintable[i][1]
              });
            var marker_to = new google.maps.Marker({
              position: {lat:itintable[i][6],lng:itintable[i][7]},
              label: itintable[i][5]
              });
            var marker_stop1 = new google.maps.Marker({
              position: {lat:itintable[i][9],lng:itintable[i][10]},
              label: itintable[i][8]
              });
            var marker_stop2 = new google.maps.Marker({
              position: {lat:itintable[i][12],lng:itintable[i][13]},
              label: itintable[i][11]
              });
            // To add the marker to the map, call setMap();
            marker_from.setMap(map);
            marker_to.setMap(map);
            marker_stop1.setMap(map);
            marker_stop2.setMap(map);

            //create empty LatLngBounds object to center the map and include all markers
            var bounds = new google.maps.LatLngBounds();
            //extend the bounds to include each marker's position
            bounds.extend(marker_from.position);
            bounds.extend(marker_to.position);
            bounds.extend(marker_stop1.position);
            bounds.extend(marker_stop2.position);
            //now fit the map to the newly inclusive bounds
            map.fitBounds(bounds);
          };};},
          error: function (request, status, error) {
            console.log(error);
          }
        });

            };


    $(document).ready(function () {
        // prepare the URL to call
        var url_to_call = './itineraries_data/LON/SYD';

        // loading image until the chart is done
        $('#map_wrapper').hide();
        $('#loading_image').show();

        // call API and pass the update date to the div

        $.ajax({
            type: 'GET',
            url: url_to_call,
            dataType: "json",
            crossDomain: true,
            success: function (api_results){
              initMap();
              result_table = api_results.data;
              update_time = new Date(api_results.update);
              document.getElementById("update_time").innerHTML = update_time.toDateString() ;
            },
            complete: function(){
                $('#loading_image').hide();
                $('#loading_extra').hide();
                $('#map_wrapper').show();
                initMap();
            },
            error: function (request, status, error) {
                console.log(error);
            }
        });

    });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwiGK11X_sFYhiNgVllolmQLTe02YFdSk&callback=initMap" async defer></script>

  <!-- HTML -->

      <div class="bg-white">
  	    <div class="container_12 ta-c pt-30 bg-white grey">
  				<div class="dib">
  					<div class="grid_4 ta-c">
  						<div class="p-5">
  							<i class="fa fa-users fa-4x sky-blue"></i>
  							<p class=" text-icon "> Based on 50M+ UMVs </p>
  						</div>
  					</div>

            <div class="grid_4 ta-c">
  						<div class="p-5">
  							<i class="fa fa-calendar fa-4x sky-blue"></i>
  							<p class=" text-icon "> In the last 12 months </p>
  						</div>
  					</div>

						<div class="grid_4 ta-c">
							<div class="p-5">
								<i class="fa fa-map-signs fa-4x sky-blue"></i>
								<p class=" text-icon ">The prefered itineraries are: </p>
							</div>
						</div>
					</div>
          <!--Div that holds the animated gif until the chart loads-->
          <div id="loading_image" class="grid_12 pb-30">
            <img src="{{ url_for('static', filename='loading.gif') }}"></img>
          </div>
	      </div>
      </div>

        <div class="bg-light-grey">
         <div class="container_12 ta-c fs-18 pb-30 pt-30">
           <div id="map_wrapper">
              <div id="map" class="mb-30"></div>
              <div class='container_12 ta-c mb-10'>
                <div class='grid_2'> &nbsp </div>
                <input id="ODinput" class='grid_4' type="text" value="AAA-BBB city codes" onfocus='if (this.value=="AAA-BBB city codes") {this.value="";}'>
                <input type="button" class="grid_3 button-style" value="draw itineraries" onClick="draw_map()">
                <input type="button" class="grid_2 button-style mb-10" value="clear" onClick="initMap()">
                <img id="loading_extra" src="{{ url_for('static', filename='loading_extra.gif') }}"></img>
              </div>
           </div>
           <span class="text-icon"> Last updated on: </span>
           <span id="update_time" class=" text-icon"> - </span>
         </div>

          <div class="container_12 info-section">
            <div class="dib">
              <div class="grid_2">
                  <i class="fa fa-info-circle fa-5x"></i>
              </div>
              <div class="grid_10">
                  <span> The map shows the preferred itineraries users chose in the last year for a particular O&D. <br/>
                    The thickness of the line indicates how popular the routing is compared to the others.
                  </span>
              </div>
            </div>
          </div>
        </div>
{% endblock %}
