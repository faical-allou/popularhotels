{% extends "header.html" %}
{% block content %}

<!-- Load the Javascript -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script type="text/javascript">

    // Load the Visualization API and the corechart package.
      google.charts.load('current', {'packages':['corechart', 'controls', 'map']});
    // Callback that creates and populates a data table,
    // instantiates the chart, passes in the data and draws it.
    function drawChart(originairport,rangekm,destinationcity) {
      var filteroriginairport = document.getElementById("originairportinput");
      var filterrangekm = document.getElementById("rangekminput");
      var filterdestinationcity = document.getElementById("destinationcityinput");


      if (originairport == null) {
        originairport = filteroriginairport.value.toUpperCase();
        rangekm = filterrangekm.value.toUpperCase();
        destinationcity= filterdestinationcity.value.toUpperCase();
        mixpanel.track("Catchment selection", {"originairport": filteroriginairport.value, "Rangekm":filterrangekm.value, "Destinationcity": filterdestinationcity.value});
      };

      var url_to_call = './catchment_data/'+originairport+'/'+rangekm+'/'+destinationcity;

      // loading image until the chart is done
      $('#loading_extra').show();
      // call API and pass the data to the drawchart function
      $.ajax({
          type: 'GET',
          url: url_to_call,
          dataType: "json",
          crossDomain: true,
          success: function (data_to_display) {
            update_time = new Date(data_to_display.update);
            document.getElementById("update_time").innerHTML = update_time.toDateString();
            if (data_to_display.airport_share > 0) {
              var recapture = Math.round(100/data_to_display.airport_share)-100;
              document.getElementById("text_recapture").innerHTML = "<strong>"+originairport+ "</strong> captures <strong>" + Math.round(data_to_display.airport_share*100) +"% </strong> of the potential from the catchment<br/>With better service (non-stop, frequency etc ...) the traffic could grow <strong>"+ recapture+"%</strong>"
            } else {
              document.getElementById("text_recapture").innerHTML = "<strong>"+originairport+" is not in the TOP 10 airports</strong> from this catchment area to go to <strong>"+destinationcity+"</strong>."
            };

            console.log(data_to_display);
            if (data_to_display.length[0] > 3 && data_to_display.length[1] > 3) {
              // Create the data table.
              data_formatted = new google.visualization.DataTable();
              data_formatted.addColumn('number', 'Lat');
              data_formatted.addColumn('number', 'Long');
              data_formatted.addColumn('string', 'City');
              data_formatted.addColumn('string', 'Marker');

              for (i = 0; i < data_to_display.length[0]; i++) {
                data_formatted.addRows([
                [
                Number(data_to_display.catchment[i][3]),
                Number(data_to_display.catchment[i][4]),
                data_to_display.catchment[i][1],
                "city"
                ]]);
              };

              data_formatted.addRows([
              [
              Number(data_to_display.airport_coord[0]),
              Number(data_to_display.airport_coord[1]),
              originairport,
              "airport"
              ]]);

              var options= {
                'height':500,
                'width':'100%',
                'legend': {position: 'none'},
                'showInfoWindow': true,
                'showTooltip': true,
                'mapType': 'normal',
                'maps': {styledMap : {name: 'Skyscanner', styles: [
                  {featureType: "administrative.land_parcel", elementType: "labels", stylers: [{"visibility": "off"}]},                    {elementType: 'geometry', stylers: [{color: '#DFDCE3'}]},
                  {featureType: 'water', elementType: 'geometry',stylers: [{color: '#272133'}]},
                        ]
                      }
                },
                'icons': {
                  _city_: { //change to city to use a custom icon
                    normal:   "{{ url_for('static', filename='citylogo.png') }}",
                    selected: "{{ url_for('static', filename='citylogo.png') }}"
                  },
                  airport: {
                    normal:   "{{ url_for('static', filename='airportlogo.png') }}",
                    selected: "{{ url_for('static', filename='airportlogo.png') }}"
                  },
                }
            };
              // Create a chart, passing some options
            var catchmentMap = new google.visualization.Map(document.getElementById('chart_div'));

            catchmentMap.draw(data_formatted, options);

            // Create the data table.
            data_formatted = new google.visualization.DataTable();
            data_formatted.addColumn('string', 'Origin');
            data_formatted.addColumn('number', 'Pax');

            for (i = 0; i < data_to_display.length[1]; i++) {
              data_formatted.addRows([
              [data_to_display.leakage[i][0],
              Number(data_to_display.leakage[i][2]),
              ]]);
            };

            // Create a chart, passing some options
          leakageChart = new google.visualization.ChartWrapper({
              'chartType': 'BarChart',
              'containerId': 'chart2_div',
              'dataTable': data_formatted,

              // The  chart will only use the columns listed - note:index start at 0 - inverted so connecting is at the bottom
              'options': {
                'title': "Most used departure airport",
                'titleTextStyle': {fontSize: 16,  bold: true},
                'legend': {position: 'none'},
                'chartArea' : {width:'60%',height:'90%'},
                'width': 300,
                'height': 500,
                'colors': ['#00b2d6'],

              },
            });

          leakageChart.draw();

            } else {
                  swal({  title: "Sorry",  text: "We don't have enough data for this request, \n are you entering an IATA airport code, distance, IATA city code?",  type: "error",  confirmButtonText: "OK"});
                  mixpanel.track("Error pop up", {"Page":viewpage, "URL": url_to_call});
              };
          },
          complete: function(){
              $('#loading_extra').hide();
              $('#loading_image').hide();
              $('#dashboard_wrapper').show();
          },
          error: function() {
            swal({  title: "Sorry",  text: "Something went wrong, please review your input.",  type: "error",  confirmButtonText: "OK"});
            mixpanel.track("Error pop up", {"Page":viewpage, "URL": url_to_call});
          }
      })
    };
    $(document).ready(function () {
        // loading image until the chart is done
        $('#dashboard_wrapper').hide();
        $('#loading_image').show();
        drawChart('CGN','20','NYC');
    });


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwiGK11X_sFYhiNgVllolmQLTe02YFdSk" async defer></script>

  <!-- HTML -->
        <div class="bg-white container_12 ta-c">
          <div class="title"> Catchment Area and Traffic Leakage </div>
          <!--Div that holds the animated gif until the chart loads-->
          <div id="loading_image" class="grid_12 pb-30">
            <img src="{{ url_for('static', filename='loading.gif') }}"></img>
          </div>
        </div>

       <div class="bg-white">
        <div class="container_12 ta-c fs-16 pb-30 pt-30">
          <div id="dashboard_wrapper">
              <div class="container_12 mb-30">
                <!--Divs that will hold each control and chart-->
                <div id="chart_div" class='grid_8'></div>
                <div id="chart2_div" class='grid_4'></div>
                <div id="text_recapture" class='grid_12 pt-30'></div>

              </div>
              <div class='container_12 filter-bar'>
                <input id="originairportinput" class='grid_3' type="text" value="airport code" onFocus='this.value=""'>
                <input id="rangekminput" class='grid_2' type="text" value="distance (km)" onFocus='this.value=""'>
                <input id="destinationcityinput" class='grid_3' type="text" value="dest. city code" onFocus='this.value=""'>

                <input type="button" class="grid_2 button-style" value="check" onClick="drawChart()">
                <img id="loading_extra" src="{{ url_for('static', filename='loading_extra.gif') }}"></img>
              </div>



              <div class="container_12 ta-c">
                <span class="text-icon"> Last updated on: </span>
                <span id="update_time" class=" text-icon"> - </span>
              </div>
            </div>
        </div>
        <div class="container_12 info-section">
          <div class="dib">
            <div class="grid_2">
                <i class="fa fa-info-circle fa-5x "></i>
            </div>
            <div class="grid_10">
                <span>
                  Traffic leakage is a major problem with airport-to-airport reporting,
                  by defining a distance around an airport, we can identify the most used airport from the catchment
                  and estimate the true traffic potential that can be recaptured 
                </span>
            </div>
          </div>
        </div>

      </div>


{% endblock %}
