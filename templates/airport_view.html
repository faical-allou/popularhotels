{% extends "header.html" %}
{% block content %}

<!-- Load the Javascript -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script type="text/javascript">

    // Load the Visualization API and the corechart package.
      google.charts.load('current', {'packages':['corechart', 'controls']});
    // Callback that creates and populates a data table,
    // instantiates the chart, passes in the data and draws it.
    function drawChart(airport) {
      var filter = document.getElementById("airportinput");
      if (isNaN(airport)) {
      airport = filter.value.toUpperCase();
      mixpanel.track("Hub selection", {"Airport": filter.value,});
      };

      var url_to_call = './airport_data/'+airport;

      // loading image until the chart is done
      $('#loading_extra').show();
      // call API and pass the data to the drawchart function
      $.ajax({
          type: 'GET',
          url: url_to_call,
          dataType: "json",
          crossDomain: true,
          success: function (data_to_display) {
            update_time = new Date(data_to_display.update);
            document.getElementById("update_time").innerHTML = update_time.toDateString() ;
            console.log(data_to_display);
            if (data_to_display.length > 80) {
          // Create the data table.
          data_formatted = new google.visualization.DataTable();
          data_formatted.addColumn('string', 'ID');
          data_formatted.addColumn('string', 'Airport');
          data_formatted.addColumn('string', 'Time of the day');
          data_formatted.addColumn('number', 'Index local arrival');
          data_formatted.addColumn('number', 'Index local departure');
          data_formatted.addColumn('number', 'Index connecting arrival');
          data_formatted.addColumn('number', 'Index connecting departure');
          data_formatted.addColumn('number', 'Local');
          data_formatted.addColumn('number', 'Connecting');

          for (i = 0; i < 24; i++) {
            console.log(i, data_to_display.data[i][2] )
            var timeofday = data_to_display.data[i][2];
            var timeofdayh = timeofday.concat("h");

                  data_formatted.addRows([
                  [data_to_display.data[i][0],
                  data_to_display.data[i][1],
                  timeofdayh,
                  data_to_display.data[i][3],
                  data_to_display.data[i][4],
                  data_to_display.data[i][5],
                  data_to_display.data[i][6],
                  data_to_display.data[i][3]-data_to_display.data[i][4],
                  data_to_display.data[i][5]-data_to_display.data[i][6]
                ]]);
              };

              // Create a chart, passing some options
          myChart = new google.visualization.ChartWrapper({
                'chartType': 'ColumnChart',
                'containerId': 'chart_div',
                'dataTable': data_formatted,
                // The  chart will only use the columns listed - note:index start at 0 - inverted so connecting is at the bottom
                'view': {'columns': [2,5,6,3,4]},
                'chartArea' : {width:'600px',height:'100%'},
                'options': {
                  'chartArea': {height: '80%', width: '92%'},
                  'series': {
                            0 : {color: '#00B2D6' },
                            1 : {color: '#00B2D6' },
                            2 : {color: '#272133' },
                            3 : {color: '#272133' },
                          },
                  'height':550,
                  'width':'100%',
                  'isStacked': true,
                  'colors': ['#00b2d6'],
                  'backgroundColor': { fill:'#FFFFFF' },
                  'legend': {position: 'none'},
                  'hAxis': {title: 'Time of the day',
                            position: 'low',
                            baselineColor: '#DFDCE3',
                            maxAlternation: 1,
                            textStyle: {color: '#272133', fontName: "Helvetica",fontSize: 16},
                            titleTextStyle: {color: '#272133', fontName: "Helvetica",fontSize: 18},
                            gridlines: {count: 4}},
                  'vAxis': {viewWindowMode: 'maximized',
                            textStyle: {color: '#272133', fontName: "Helvetica",fontSize: 16},
                            titleTextStyle: {color: '#272133', fontName: "Helvetica",fontSize: 18},
                            gridlines: {count: 0}},
                },
              });

              // Establish dependencies, declaring that 'filter' drives 'Chart',
              // so that the  chart will only display entries that are let through
              // given the filter

            var filtered_view = new google.visualization.DataView(data_formatted);
            var agg_table = google.visualization.data.group(
                data_formatted,
                [1],
                [
                  {'column': 7, 'aggregation': google.visualization.data.sum, 'type': 'number'},
                  {'column': 8, 'aggregation': google.visualization.data.sum, 'type': 'number'}
                ]
            );
            var local_value = agg_table.getValue(0, 1);
            var connect_value = agg_table.getValue(0, 2);
            var total_value = local_value + connect_value;
            var data_for_pie = google.visualization.arrayToDataTable(
                [['Type', 'Index'],['Local', Math.round(local_value*100/total_value)],['Connecting', Math.round(connect_value*100/total_value)]], false
            );

            myPieChart = new google.visualization.ChartWrapper({
                'chartType': 'PieChart',
                'containerId': 'piechart_div',
                'dataTable' : data_for_pie,
                'options': {
                  'chartArea': {height: '80%', width: '80%'},
                  'fontSize': 14,
                  'height':200,
                  'width':200,
                  'slices': {
                            0 : {color: '#272133'},
                            1 : {color: '#00B2D6'},
                          },
                  'colors': ['#00b2d6'],
                  'backgroundColor': { fill:'#FFFFFF' },
                  'legend': {position: 'none',},
                },
              });
              myChart.draw();
              myPieChart.draw();
            } else {alert("Sorry we don't have enough data for this request\nAre you sure you are entering an IATA airport code? ")}
            },
            complete: function(){
              $('#loading_extra').hide();
              $('#loading_image').hide();
              $('#dashboard_wrapper').show();
            }
      });
    };

    $(document).ready(function () {
        // loading image until the chart is done
        $('#dashboard_wrapper').hide();
        $('#loading_image').show();
        drawChart('MAD');
    });


    </script>

  <!-- HTML -->
        <div class="bg-white container_12 ta-c">
          <div class="title"> Hub Graph </div>
          <!--Div that holds the animated gif until the chart loads-->
          <div id="loading_image" class="grid_12 pb-30">
            <img src="{{ url_for('static', filename='loading.gif') }}"></img>
          </div>
        </div>

       <div class="bg-white">
        <div class="container_12 ta-c fs-16 pb-30 pt-30">
          <div id="dashboard_wrapper">
              <div class="container_12 mb-30">
                <!--Divs that will hold each control and chart-->
                <div id="piechart_div" class='grid_4'></div>
                <div id="chart_div" class='grid_8'></div>
              </div>
              <div class='container_12 filter-bar'>
                <div class='grid_3'> &nbsp </div>
                <input id="airportinput" class='grid_4' type="text" value="MAD" onFocus='this.value=""'>
                <input type="button" class="grid_3 button-style" value="draw hub graph" onClick="drawChart()">
                <img id="loading_extra" src="{{ url_for('static', filename='loading_extra.gif') }}"></img>
              </div>
              <div class="container_12 ta-c">
                <span class="text-icon"> Last updated on: </span>
                <span id="update_time" class=" text-icon"> - </span>
              </div>
            </div>
        </div>
        <div class="container_12 info-section">
          <div class="dib">
            <div class="grid_2">
                <i class="fa fa-info-circle fa-5x "></i>
            </div>
            <div class="grid_10">
                <span>
                  Use this data to find out when flights should be scheduled
                  to maximise and coincide with as many connections as possible.
                  The visualization shows the number of arrivals above the line
                  (people arriving at the airport add up) and departures below
                  (reducing the number of people at the airport). </br>
                  The values are index with 100 being the highest (or -100 the lowest).
                </span>
            </div>
          </div>
        </div>

      </div>


{% endblock %}
